# Alertmanager Configuration for VeloZ
# See: https://prometheus.io/docs/alerting/latest/configuration/

global:
  # Default SMTP settings (optional)
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@veloz.io'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'

  # Default Slack settings (optional)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

  # PagerDuty settings
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

  # Opsgenie settings
  opsgenie_api_url: 'https://api.opsgenie.com/'

  # Resolve timeout
  resolve_timeout: 5m

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alert routing
route:
  # Default receiver
  receiver: 'default-receiver'

  # Group alerts by these labels
  group_by: ['alertname', 'service', 'severity']

  # Wait before sending first notification for a group
  group_wait: 30s

  # Wait before sending subsequent notifications for a group
  group_interval: 5m

  # Wait before re-sending a notification
  repeat_interval: 4h

  # Child routes for specific alert routing
  routes:
    # Critical alerts go to PagerDuty immediately
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 1h

    # Warning alerts go to Slack/Opsgenie
    - match:
        severity: warning
      receiver: 'opsgenie-warning'
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 4h

    # Trading-specific alerts
    - match:
        service: execution
      receiver: 'trading-alerts'
      group_wait: 10s
      group_interval: 1m

    # Risk alerts
    - match:
        service: risk
      receiver: 'risk-alerts'
      group_wait: 10s
      group_interval: 1m

# Inhibition rules to suppress alerts
inhibit_rules:
  # If critical alert is firing, suppress warnings for same alertname
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # If gateway is down, suppress other gateway alerts
  - source_match:
      alertname: 'VeloZGatewayDown'
    target_match:
      service: 'gateway'
    equal: ['instance']

  # If engine is down, suppress trading alerts
  - source_match:
      alertname: 'VeloZEngineDown'
    target_match_re:
      service: 'execution|oms|risk'

# Receiver configurations
receivers:
  # Default receiver (email/Slack)
  - name: 'default-receiver'
    email_configs:
      - to: 'alerts@veloz.io'
        send_resolved: true
    slack_configs:
      - channel: '#veloz-alerts'
        send_resolved: true
        title: '{{ template "slack.veloz.title" . }}'
        text: '{{ template "slack.veloz.text" . }}'

  # PagerDuty for critical alerts
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: '{{ if eq .Status "firing" }}critical{{ else }}info{{ end }}'
        description: '{{ template "pagerduty.veloz.description" . }}'
        details:
          firing: '{{ template "pagerduty.veloz.firing" . }}'
          num_firing: '{{ .Alerts.Firing | len }}'
          num_resolved: '{{ .Alerts.Resolved | len }}'

  # Opsgenie for warning alerts
  - name: 'opsgenie-warning'
    opsgenie_configs:
      - api_key: '${OPSGENIE_API_KEY}'
        message: '{{ template "opsgenie.veloz.message" . }}'
        description: '{{ template "opsgenie.veloz.description" . }}'
        priority: '{{ if eq .Status "firing" }}P3{{ else }}P5{{ end }}'
        tags: 'veloz,{{ .CommonLabels.service }},{{ .CommonLabels.severity }}'

  # Trading-specific alerts (high priority)
  - name: 'trading-alerts'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_TRADING_KEY}'
        severity: '{{ if eq .Status "firing" }}error{{ else }}info{{ end }}'
        description: 'Trading Alert: {{ .CommonAnnotations.summary }}'
    slack_configs:
      - channel: '#veloz-trading-alerts'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'Trading Alert'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # Risk alerts (high priority)
  - name: 'risk-alerts'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_RISK_KEY}'
        severity: '{{ if eq .Status "firing" }}error{{ else }}info{{ end }}'
        description: 'Risk Alert: {{ .CommonAnnotations.summary }}'
    opsgenie_configs:
      - api_key: '${OPSGENIE_API_KEY}'
        message: 'Risk Alert: {{ .CommonAnnotations.summary }}'
        priority: 'P2'
        tags: 'veloz,risk,{{ .CommonLabels.severity }}'
