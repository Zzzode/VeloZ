name: ci

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Development build and tests
  dev-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up CMake
        uses: lukka/get-cmake@v3
        with:
          cmakeVersion: 3.27.7

      - name: Configure (dev)
        run: cmake --preset dev

      - name: Build (dev-all)
        run: cmake --build --preset dev-all -j$(nproc)

      - name: Run all tests
        run: ctest --preset dev -j$(nproc)

      - name: Smoke run engine
        run: timeout 3s ./build/dev/apps/engine/veloz_engine || true

  # Release build
  release-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up CMake
        uses: lukka/get-cmake@v3
        with:
          cmakeVersion: 3.27.7

      - name: Configure (release)
        run: cmake --preset release

      - name: Build (release-all)
        run: cmake --build --preset release-all -j$(nproc)

      - name: Smoke run engine (release)
        run: timeout 3s ./build/release/apps/engine/veloz_engine || true

  # ASan build and tests (memory error detection)
  asan-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up CMake
        uses: lukka/get-cmake@v3
        with:
          cmakeVersion: 3.27.7

      - name: Install Clang
        run: sudo apt-get update && sudo apt-get install -y clang-16

      - name: Configure (asan)
        run: cmake --preset asan

      - name: Build (asan-all)
        run: cmake --build --preset asan-all -j$(nproc)

      - name: Run all tests with ASan
        run: ctest --test-dir build/asan -j$(nproc)

  # Code format check
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check C++ format
        run: |
          ./scripts/format.sh --check 2>&1 || {
            echo "Code formatting check failed. Please run ./scripts/format.sh to fix."
            exit 1
          }

  # Documentation check
  docs-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for broken links in documentation
        run: |
          if [ -d "docs" ]; then
            echo "Checking documentation..."
            # Simple check for documentation structure integrity
            test -f "README.md" || exit 1
            test -f "CLAUDE.md" || exit 1
            test -d "docs" || exit 1
          fi

  # Python code check
  python-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          if [ -f "python/requirements.txt" ]; then
            pip install -r python/requirements.txt
          fi
          if [ -f "apps/gateway/requirements.txt" ]; then
            pip install -r apps/gateway/requirements.txt
          fi

      - name: Lint Python code
        run: |
          if [ -d "python" ] || [ -d "apps/gateway" ]; then
            pip install flake8
            targets=()
            if [ -d "python" ]; then
              targets+=("python")
            fi
            if [ -d "apps/gateway" ]; then
              targets+=("apps/gateway")
            fi
            if [ ${#targets[@]} -gt 0 ]; then
              flake8 "${targets[@]}" --count --select=E9,F63,F7,F82 --show-source --statistics
              flake8 "${targets[@]}" --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
            fi
          fi

  # Database migration tests
  migration-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install sqlalchemy alembic psycopg2-binary pytest

      - name: Run migration tests
        working-directory: apps/gateway
        run: |
          python -m pytest db/test_migrations.py -v

      - name: Check migration can be applied
        working-directory: apps/gateway
        env:
          VELOZ_DATABASE_URL: sqlite:///test_migrations.db
        run: |
          python -m db.migrate init
          python -m db.migrate check
          python -m db.migrate current

      - name: Test migration rollback
        working-directory: apps/gateway
        env:
          VELOZ_DATABASE_URL: sqlite:///test_migrations.db
        run: |
          python -m db.migrate downgrade base
          python -m db.migrate upgrade head
