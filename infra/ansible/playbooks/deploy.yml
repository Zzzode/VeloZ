---
# VeloZ Deployment Playbook
# Deploys VeloZ to Kubernetes using Helm with blue-green strategy

- name: Deploy VeloZ Trading Engine
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    veloz_namespace: "veloz"
    veloz_release_name: "veloz"
    veloz_chart_path: "../../helm/veloz"
    deployment_strategy: "blue-green"  # blue-green or rolling
    health_check_retries: 30
    health_check_delay: 10

  vars_files:
    - "vars/{{ environment }}.yml"

  tasks:
    - name: Validate environment
      ansible.builtin.assert:
        that:
          - environment is defined
          - environment in ['dev', 'staging', 'production']
        fail_msg: "Environment must be one of: dev, staging, production"

    - name: Get current deployment color
      kubernetes.core.k8s_info:
        api_version: v1
        kind: ConfigMap
        namespace: "{{ veloz_namespace }}"
        name: veloz-deployment-state
      register: deployment_state
      ignore_errors: true

    - name: Set deployment colors
      ansible.builtin.set_fact:
        current_color: "{{ deployment_state.resources[0].data.active_color | default('blue') }}"
        new_color: "{{ 'green' if (deployment_state.resources[0].data.active_color | default('blue')) == 'blue' else 'blue' }}"
      when: deployment_strategy == "blue-green"

    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          Environment: {{ environment }}
          Strategy: {{ deployment_strategy }}
          {% if deployment_strategy == 'blue-green' %}
          Current color: {{ current_color }}
          New color: {{ new_color }}
          {% endif %}
          Image tag: {{ veloz_image_tag }}

    # Blue-Green Deployment
    - name: Blue-Green Deployment
      when: deployment_strategy == "blue-green"
      block:
        - name: Deploy new version ({{ new_color }})
          kubernetes.core.helm:
            name: "{{ veloz_release_name }}-{{ new_color }}"
            chart_ref: "{{ veloz_chart_path }}"
            release_namespace: "{{ veloz_namespace }}"
            create_namespace: true
            values_files:
              - "{{ veloz_chart_path }}/environments/values-{{ environment }}.yml"
            values:
              engine:
                image:
                  tag: "{{ veloz_image_tag }}"
                env:
                  VELOZ_DEPLOYMENT_COLOR: "{{ new_color }}"
              # Don't expose service yet
              engine:
                service:
                  type: ClusterIP
            wait: true
            wait_timeout: "600s"

        - name: Wait for new deployment to be ready
          kubernetes.core.k8s_info:
            api_version: apps/v1
            kind: Deployment
            namespace: "{{ veloz_namespace }}"
            name: "{{ veloz_release_name }}-{{ new_color }}"
          register: new_deployment
          until:
            - new_deployment.resources | length > 0
            - new_deployment.resources[0].status.readyReplicas | default(0) == new_deployment.resources[0].spec.replicas
          retries: "{{ health_check_retries }}"
          delay: "{{ health_check_delay }}"

        - name: Run health checks on new deployment
          ansible.builtin.uri:
            url: "http://{{ veloz_release_name }}-{{ new_color }}.{{ veloz_namespace }}.svc.cluster.local:8080/health"
            method: GET
            return_content: true
          register: health_check
          until: health_check.status == 200
          retries: "{{ health_check_retries }}"
          delay: "{{ health_check_delay }}"
          delegate_to: localhost

        - name: Switch traffic to new deployment
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: v1
              kind: Service
              metadata:
                name: "{{ veloz_release_name }}"
                namespace: "{{ veloz_namespace }}"
              spec:
                selector:
                  app.kubernetes.io/name: veloz
                  app.kubernetes.io/instance: "{{ veloz_release_name }}-{{ new_color }}"
                ports:
                  - port: 8080
                    targetPort: 8080
                    protocol: TCP

        - name: Update deployment state
          kubernetes.core.k8s:
            state: present
            definition:
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: veloz-deployment-state
                namespace: "{{ veloz_namespace }}"
              data:
                active_color: "{{ new_color }}"
                previous_color: "{{ current_color }}"
                last_deployment: "{{ ansible_date_time.iso8601 }}"
                image_tag: "{{ veloz_image_tag }}"

        - name: Keep old deployment for rollback (scaled down)
          kubernetes.core.helm:
            name: "{{ veloz_release_name }}-{{ current_color }}"
            chart_ref: "{{ veloz_chart_path }}"
            release_namespace: "{{ veloz_namespace }}"
            values_files:
              - "{{ veloz_chart_path }}/environments/values-{{ environment }}.yml"
            values:
              engine:
                replicaCount: 0
            wait: true
          when: keep_previous_deployment | default(true)

    # Rolling Deployment
    - name: Rolling Deployment
      when: deployment_strategy == "rolling"
      block:
        - name: Deploy with rolling update
          kubernetes.core.helm:
            name: "{{ veloz_release_name }}"
            chart_ref: "{{ veloz_chart_path }}"
            release_namespace: "{{ veloz_namespace }}"
            create_namespace: true
            values_files:
              - "{{ veloz_chart_path }}/environments/values-{{ environment }}.yml"
            values:
              engine:
                image:
                  tag: "{{ veloz_image_tag }}"
            wait: true
            wait_timeout: "600s"

        - name: Wait for rollout to complete
          kubernetes.core.k8s_info:
            api_version: apps/v1
            kind: Deployment
            namespace: "{{ veloz_namespace }}"
            name: "{{ veloz_release_name }}"
          register: deployment
          until:
            - deployment.resources | length > 0
            - deployment.resources[0].status.readyReplicas | default(0) == deployment.resources[0].spec.replicas
          retries: "{{ health_check_retries }}"
          delay: "{{ health_check_delay }}"

    - name: Deployment complete
      ansible.builtin.debug:
        msg: |
          Deployment completed successfully!
          Environment: {{ environment }}
          Image tag: {{ veloz_image_tag }}
          {% if deployment_strategy == 'blue-green' %}
          Active color: {{ new_color }}
          {% endif %}
