# HAProxy Configuration for VeloZ HA

global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s
    timeout tunnel 1h

# Stats page
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# VeloZ API Frontend
frontend veloz_api
    bind *:8080
    mode http

    # Health check endpoint (no auth required)
    acl is_health path_beg /health
    acl is_metrics path_beg /metrics

    # Default backend
    default_backend veloz_engines

# VeloZ Engine Backend
backend veloz_engines
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # Health check settings
    default-server inter 3s fall 3 rise 2

    # Engine servers with health checks
    server engine-1 veloz-engine-1:8080 check
    server engine-2 veloz-engine-2:8080 check backup

    # Stick tables for session persistence (if needed)
    # stick-table type ip size 100k expire 30m
    # stick on src

# PostgreSQL Frontend (for direct database access if needed)
frontend postgres_frontend
    bind *:5432
    mode tcp
    default_backend postgres_primary

# PostgreSQL Primary Backend
backend postgres_primary
    mode tcp
    option pgsql-check user veloz
    server postgres-primary postgres-primary:5432 check

# PostgreSQL Read Replicas (for read scaling)
backend postgres_replicas
    mode tcp
    balance roundrobin
    option pgsql-check user veloz
    server postgres-primary postgres-primary:5432 check
    server postgres-standby postgres-standby:5432 check backup

# Redis Frontend (via Sentinel)
frontend redis_frontend
    bind *:6379
    mode tcp
    default_backend redis_master

backend redis_master
    mode tcp
    option tcp-check
    tcp-check connect
    tcp-check send AUTH\ redis\r\n
    tcp-check expect string +OK
    tcp-check send PING\r\n
    tcp-check expect string +PONG
    tcp-check send info\ replication\r\n
    tcp-check expect string role:master
    server redis-master redis-master:6379 check inter 1s
    server redis-replica redis-replica:6379 check inter 1s backup
