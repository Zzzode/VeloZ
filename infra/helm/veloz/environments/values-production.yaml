# Production environment values
# Usage: helm install veloz ./veloz -f environments/values-production.yaml -n veloz-prod

global:
  environment: production
  imagePullSecrets:
    - name: veloz-registry-credentials

engine:
  # Single replica for trading to avoid duplicate orders
  # Use multiple replicas only with proper order deduplication
  replicaCount: 1

  image:
    repository: registry.example.com/veloz-engine
    tag: "1.0.0"
    pullPolicy: IfNotPresent

  resources:
    requests:
      memory: "1Gi"
      cpu: "1"
    limits:
      memory: "2Gi"
      cpu: "4"

  env:
    VELOZ_PRESET: "release"
    VELOZ_EXECUTION_MODE: "binance_spot"
    VELOZ_BINANCE_BASE_URL: "https://api.binance.com"
    VELOZ_BINANCE_TRADE_BASE_URL: "https://api.binance.com"

  # Production-grade probes
  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 5

  readinessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Node affinity for dedicated trading nodes
  nodeSelector:
    workload-type: trading

  tolerations:
    - key: "workload-type"
      operator: "Equal"
      value: "trading"
      effect: "NoSchedule"

  # Anti-affinity to spread across zones
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: veloz
            topologyKey: topology.kubernetes.io/zone

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

# Use Vault for secrets
secrets:
  useExternal: true
  externalProvider: vault
  vault:
    address: "https://vault.example.com"
    path: "secret/data/veloz/production"
    role: "veloz-production"

# External PostgreSQL (RDS)
database:
  external: true
  url: "postgresql://veloz:$(DB_PASSWORD)@veloz-prod.xxxxx.us-east-1.rds.amazonaws.com:5432/veloz"

# External Redis (ElastiCache)
redis:
  enabled: false  # Using external ElastiCache

# Production ingress
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
  hosts:
    - host: veloz.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: veloz-prod-tls
      hosts:
        - veloz.example.com

# Autoscaling disabled for trading (single replica)
autoscaling:
  enabled: false

# PDB for production
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Strict network policy
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
  egress:
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

# Full monitoring with alerting
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 10s
    scrapeTimeout: 5s
    labels:
      release: prometheus
  prometheusRule:
    enabled: true
    labels:
      release: prometheus
    rules:
      # Critical trading alerts
      - alert: VelozOrderExecutionFailure
        expr: increase(veloz_order_execution_failures_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Order execution failure detected"
          description: "VeloZ has failed to execute orders in the last 5 minutes"

      - alert: VelozHighOrderLatency
        expr: histogram_quantile(0.99, sum(rate(veloz_order_latency_seconds_bucket[5m])) by (le)) > 0.5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High order execution latency"
          description: "99th percentile order latency is above 500ms"

      - alert: VelozPositionRiskBreach
        expr: veloz_position_risk_score > 0.9
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Position risk threshold breached"
          description: "Position risk score is above 90%"

logging:
  level: INFO
  format: json

# Persistence for audit logs
persistence:
  enabled: true
  storageClass: "gp3"
  accessModes:
    - ReadWriteOnce
  size: 100Gi
  annotations:
    backup.velero.io/backup-volumes: "data"

# Service account with IRSA for AWS
serviceAccount:
  create: true
  name: veloz
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/veloz-production"
